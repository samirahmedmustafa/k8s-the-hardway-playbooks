---
LB:
  hosts:
    lb:
      ansible_host: 192.168.1.50
  vars:
    ports:
      - 6443/tcp
    selinux_state: permissive
    pkgs:
      - haproxy-3.0.5
      - wget
      - vim
    templates:
      - src: templates/haproxy.cfg.j2
        dst: /etc/haproxy/haproxy.cfg
    kube_apiserver_port: 6443
    service_name: haproxy
ETCD:
  hosts:
    etcd-server1:
      ansible_host: 192.168.1.51
      host_files:
        cert-file:
          src: files/etcd-server1.crt
          dst: /etc/etcd/etcd-server1.crt
        key-file:
          src: files/etcd-server1.key
          dst: /etc/etcd/etcd-server1.key
        peer-cert-file:
          src: files/etcd-server1.crt
          dst: /etc/etcd/etcd-server1.crt
        peer-key-file:
          src: files/etcd-server1.key
          dst: /etc/etcd/etcd-server1.key
    etcd-server2:
      ansible_host: 192.168.1.52
      host_files:
        cert-file:
          src: files/etcd-server2.crt
          dst: /etc/etcd/etcd-server2.crt
        key-file:
          src: files/etcd-server2.key
          dst: /etc/etcd/etcd-server2.key
        peer-cert-file:
          src: files/etcd-server2.crt
          dst: /etc/etcd/etcd-server2.crt
        peer-key-file:
          src: files/etcd-server2.key
          dst: /etc/etcd/etcd-server2.key
  vars:
    ports:
      - 2380/tcp
      - 2379/tcp
    selinux_state: permissive
    pkgs:
      - wget
      - vim
    cluster_files:
      ca-key:
        src: files/etcd-ca.key
        dst: /etc/etcd/etcd-ca.key
      ca-cert:
        src: files/etcd-ca.crt
        dst: /etc/etcd/etcd-ca.crt
      trusted-ca-file:
        src: files/etcd-ca.crt
        dst: /etc/etcd/etcd-ca.crt
      peer-trusted-ca-file:
        src: files/etcd-ca.crt
        dst: /etc/etcd/etcd-ca.crt
    urls:
      etcd:
        src: https://github.com/etcd-io/etcd/releases/download/v3.6.7/etcd-v3.6.7-linux-amd64.tar.gz
        dst: /usr/local/bin
    templates:
      - src: templates/etcd.service.j2
        dst: /etc/systemd/system/etcd.service
    service_name: etcd
    dirs:
      data_dir: /var/lib/etcd
      etcd_conf: /etc/etcd
KUBE_APISERVER:
  hosts:
    master-1:
      ansible_host: 192.168.1.51
      host_files:
        etcd-keyfile:
          src: files/etcd-server1.key
          dst: /var/lib/kubernetes/etcd-server1.key
        etcd-certfile:
          src: files/etcd-server1.crt
          dst: /var/lib/kubernetes/etcd-server1.crt
    master-2:
      ansible_host: 192.168.1.52
      host_files:
        etcd-keyfile:
          src: files/etcd-server2.key
          dst: /var/lib/kubernetes/etcd-server2.key
        etcd-certfile:
          src: files/etcd-server2.crt
          dst: /var/lib/kubernetes/etcd-server2.crt
  vars:
    ports:
      - 6443/tcp
    selinux_state: permissive
    etcd_endpoints:
      - https://192.168.1.51:2379
      - https://192.168.1.52:2379
    pkgs:
      - wget
      - vim

    adminaccount_files:
      admin-account-key:
        src: files/admin.key
        dst: /var/lib/kubernetes/admin.key
      admin-account-cert:
        src: files/admin.crt
        dst: /var/lib/kubernetes/admin.crt
    admin_kubeconfig: /var/lib/kubernetes/admin.kubeconfig
    serviceaccount_files:
      service-account-key-file:
        src: files/service-account.crt
        dst: /var/lib/kubernetes/service-account.crt
      service-account-signing-key-file:
        src: files/service-account.key 
        dst: /var/lib/kubernetes/service-account.key 

    cluster_files:
      ca-key:
        src: files/etcd-ca.key
        dst: /etc/etcd/etcd-ca.key
      ca-cert:
        src: files/etcd-ca.crt
        dst: /etc/etcd/etcd-ca.crt
      tls-private-key-file:
        src: files/kube-apiserver.key
        dst: /var/lib/kubernetes/kube-apiserver.key
      tls-cert-file:
        src: files/kube-apiserver.crt
        dst: /var/lib/kubernetes/kube-apiserver.crt
      client-ca-file:
        src: files/ca.crt
        dst: /var/lib/kubernetes/ca.crt
      kubelet-client-key:
        src: files/kube-apiserver.key
        dst: /var/lib/kubernetes/kube-apiserver.key
      kubelet-client-certificate:
        src: files/kube-apiserver.crt
        dst: /var/lib/kubernetes/kube-apiserver.crt
      kubelet-certificate-authority:
        src: files/ca.crt
        dst: /var/lib/kubernetes/ca.crt
      etcd-cafile:
        src: files/etcd-ca.crt
        dst: /var/lib/kubernetes/etcd-ca.crt
      encryption-provider-config:
        src: files/encryption-config.yaml
        dst: /var/lib/kubernetes/encryption-config.yaml

    params:
      service-cluster-ip-range: 10.96.0.0/12
      cluster_name: home-cluster
    urls:
      kube_apiserver:
        src: https://dl.k8s.io/v1.34.2/bin/linux/amd64/kube-apiserver
        dst: /usr/local/bin/kube-apiserver
      kubectl:
        src: https://dl.k8s.io/v1.34.2/bin/linux/amd64/kubectl
        dst: /usr/local/bin/kubectl
    service_name: kube-apiserver
    dirs:
      data_dir: /var/lib/kubernetes
    templates:
      - src: templates/kube-apiserver.service.j2
        dst: /etc/systemd/system/kube-api.service
KUBE_CONTROLLER_MANAGER:
  hosts:
    kube-controller-manager-1:
      ansible_host: 192.168.1.51
    kube-controller-manager-2:
      ansible_host: 192.168.1.52
  vars:
    ports: []
    selinux_state: permissive
    params:
      cluster_name: home-cluster
      creds: system:kube-controller-manager
      cluster_cidr: 192.168.1.0/24
      service-cluster-ip-range: 10.96.0.0/12
      token_file: /var/lib/kubernetes/bootstrap-token.yaml
      root-ca-file: /var/lib/kubernetes/ca.key
      cluster-signing-key-file: /var/lib/kubernetes/ca.key
      cluster-signing-cert-file: /var/lib/kubernetes/ca.crt
      service-account-private-key-file: /var/lib/kubernetes/service-account.key
      kubeconfig: /var/lib/kubernetes/kube-controller-manager.kubeconfig
      expiration: 2037-03-10T03:22:11Z
      auth-extra-groups: "system:bootstrappers:worker,system:bootstrappers:ingress"
      controllers: "*,bootstrapsigner,tokencleaner" #("*,tokencleaner" | *,bootstrapsigner,tokencleaner)
    pkgs:
      - wget
      - vim

    cluster_files:
      kube-controller-manager-key:
        src: files/kube-controller-manager.key
        dst: /var/lib/kubernetes/kube-controller-manager.key
      kube-controller-manager-cert:
        src: files/kube-controller-manager.crt
        dst: /var/lib/kubernetes/kube-controller-manager.crt
    templates:
      - src: templates/kube-controller-manager.service.j2
        dst: /etc/systemd/system/kube-controller-manager.service
    urls:
      kube_controller_manager:
        src: https://dl.k8s.io/v1.34.2/bin/linux/amd64/kube-controller-manager
        dst: /usr/local/bin/kube-controller-manager
    service_name: kube-controller-manager
KUBE_SCHEDULER:
  hosts:
    kube-scheduler-1:
      ansible_host: 192.168.1.51
    kube-scheduler-2:
      ansible_host: 192.168.1.52
  vars:
    ports: []
    selinux_state: permissive
    pkgs:
      - wget
      - vim
    params:
      kubeconfig: /var/lib/kubernetes/kube-scheduler.kubeconfig
      cluster_name: home-cluster
      ca_certs: /var/lib/kubernetes/ca.crt
      creds: system:kube-scheduler

    cluster_files:
      kube-scheduler-key:
        src: files/kube-scheduler.key
        dst: /var/lib/kubernetes/kube-scheduler.key
      kube-scheduler-cert:
        src: files/kube-scheduler.crt
        dst: /var/lib/kubernetes/kube-scheduler.crt
    templates:
      - src: templates/kube-scheduler.service.j2
        dst: /etc/systemd/system/kube-scheduler.service
    urls:
      kube_scheduler:
        src: https://dl.k8s.io/v1.34.2/bin/linux/amd64/kube-scheduler
        dst: /usr/local/bin/kube-scheduler
    service_name: kube-scheduler
KUBELET:
  hosts:
    worker-1:
      ansible_host: 192.168.1.53
      host_files: []
    worker-2:
      ansible_host: 192.168.1.54
      host_files: []
  vars:
    ports:
      - 10250/tcp
    selinux_state: permissive
    pkgs:
      - wget
      - vim
    cluster_files:
      client-ca-file:
        src: files/ca.crt
        dst: /var/lib/kubernetes/ca.crt
      kubelet-key:
        src: files/kubelet.key
        dst: /var/lib/kubernetes/kubelet.key
      kubelet-cert:
        src: files/kubelet.crt
        dst: /var/lib/kubernetes/kubelet.crt
    params:
      kubeconfig: /var/lib/kubernetes/kubeconfig
      config: /var/lib/kubernetes/config.yaml
      bootstrap-kubeconfig: /var/lib/kubernetes/bootstrap-kubeconfig
      cluster_name: home-cluster
      resolvConf: /etc/resolv_k8s.conf
      ca_certs: /var/lib/kubernetes/ca.crt
      creds: system:kube-scheduler
    urls:
      kubelet:
        - src: https://dl.k8s.io/v1.34.2/bin/linux/amd64/kubelet
          dst: /usr/local/bin/kubelet
        - src: https://github.com/containerd/containerd/releases/download/v2.2.1/containerd-2.2.1-linux-amd64.tar.gz
          dst: /usr/local/bin/
        - src: https://github.com/opencontainers/runc/releases/download/v1.4.0/runc.amd64      
          dst: /usr/local/sbin/runc
    templates:
      - src: templates/kubelet.service.j2
        dst: /etc/systemd/system/kubelet.service
      - src: templates/containerd.service.j2
        dst: /etc/systemd/system/containerd.service
    service_name:
      - containerd
      - kubelet
all:
  vars:
    common:
      pkgs:
        - tar
        - wget
        - vim

      templates:
        - src: templates/hosts.j2
          dst: /etc/hosts

      filebeat:
        app_base_dir: /opt/filebeat
        service: filebeat
        compressed: files/filebeat-9.2.4-linux-x86_64.tar.gz
        templates:
          - src: templates/filebeat.service.j2
            dst: /etc/systemd/system/filebeat.service

        sys_groups:
          filebeat:
            name: filebeat

        sys_users:
          filebeat:
            name: filebeat
            shell: /sbin/nologin
            groups: filebeat

        conf_files_perm:
          filebeat:
            path: /opt/filebeat/filebeat.yml
            mode: "0640"

        filebeat_regex:
          path: /opt/filebeat/filebeat.yml
          regex:
            - old: "localhost:9200"
              new: "192.168.1.11:9200"
            - old: '#username: "elastic"'
              new: 'username: "elastic"'
            - old: '#password: "changeme"'
              new: 'password: "changeme"'
            - old: '^#- type: journald'
              new: '- type: journald'
            - old: '^#- type: journald'
              new: '- type: journald'
            - old: '#id: my-journald-id'
              new: 'id: my-journald-id'
            - old: '#seek: head'
              new: 'seek: tail'
            - old: 'path: \${path.config}/modules.d/\*.yml'
              new: '#path: \${path.config}/modules.d/\*.yml'
            - old: '#logging.level: debug'
              new: 'logging.level: warning' 

